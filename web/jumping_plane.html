<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<title>jumping plane</title>

<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Bootstrap -->
<link rel="stylesheet" href="./css/bootstrap.min.css">
<!-- Normal css -->
<link rel="stylesheet" href="main_sub_styles.css">

<!-- Vanaf sratch nagebouwd: flappy bird, maar dan met een plane. 
Op basis van w3schools: https://www.w3schools.com/graphics/game_intro.asp en 
flappybird tutorial: https://www.youtube.com/watch?v=riUx2G75mas&t=1189s -->

</head>

<!-- Body -->
<!-- Navigation 

<nav class="navbar default navbar-fixed-top col-md-offset-0 col-md-12 col-lg-12 col-lg-offset-0">
  <div class="container-fluid"> 
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" > <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
      <a class="navbar-brand"><img src="./img/logo_belle.png" alt="Belle AIR" style="width:150px;"> </a></div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" style="margin-right: 50px"->
        <li><a href="home_menu.html">Home</a> </li>
        <li><a href="movies_genres.html">Movies</a> </li>
        <li class="active"><a href="games.html">Games</a> </li>
        <li><a href="flight_form.html">Flight info</a> </li>
        <li><a href="Internet.html">Internet</a> </li>
        <li class="dropdown"> <a href="music_genres.html" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true">Music <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="music_genres.html">Genres</a> </li>
            <li><a href="music_artists.html">Artists</a> </li>
            <li><a href="music_songs.html">Songs</a> </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>
 /Navigation --> 
</head>

<body>
<img src="img/insidePlane.jpg" id="game" alt="">

<!-- FOOTER 
  <div class="container-fluid">
    <footer id="footer"  style="text-align: center;">
        <p>Copyright Â© SKY is the LIMIT</p>
      </div>
    </footer> 
  </div>
 / FOOTER --> 

 <script >

var 

s_plane,
s_bg,
s_fg,
s_cloud,
s_palm,
s_text,
s_score,
s_splash,
s_buttons,
s_numberS,
s_numberB;


function Sprite(img, x, y, width, height) {
  this.img = img;
  this.x = x*2;
  this.y = y*2;
  this.width = width*2;
  this.height = height*2;
};

Sprite.prototype.draw = function(ctx, x, y) {
  ctx.drawImage(this.img, this.x, this.y, this.width, this.height,
    x, y, this.width, this.height);
};

function initSprites(img) {

  s_plane = [
    new Sprite(img, 156, 129, 56, 14),
    new Sprite(img, 156, 115, 56, 14),
    new Sprite(img, 156, 141, 56, 14)

  ];
  
  s_bg = new Sprite(img,   0, 0, 138, 114);
  s_bg.color = "#219FCE";
  s_fg = new Sprite(img, 138, 0, 112,  56);
  
  s_palm = new Sprite(img, 251, 0, 51, 200);
  s_cloud = new Sprite(img, 303, 0, 52, 200);
  
  s_text = {
    GameOver:   new Sprite(img, 59, 136, 94, 19),
    GetReady:   new Sprite(img, 59, 155, 87, 22)
  }
  s_buttons = {
    Score: new Sprite(img,  79, 191, 40, 14),
    Ok:    new Sprite(img, 120, 180, 40, 17)
  }

  s_score  = new Sprite(img, 200,  56, 57, 58);
  s_splash = new Sprite(img,   0, 114,  59, 49);

  s_numberS = new Sprite(img, 0, 177, 6,  7);
  s_numberB = new Sprite(img, 0, 188, 7, 10);

// methode voor score  
  s_numberS.draw = s_numberB.draw = function(ctx, x, y, num, offset) {
    num = num.toString();
    var step = this.width + 2;

    if (offset) {
      x += step * (offse - num.length );
    }

    for (var i = 0, len = num.length; i < len; i++) {
      var n = parseInt(num[i]);
      ctx.drawImage(img, step*n, this.y, this.width, this.height,
        x, y, this.width, this.height)
      x += step;
    }
  }
}
  </script>

  <style>
  canvas {
    display: block;
    position: absolute;
    margin: auto;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  </style>

<script>

var 

canvas,
ctx,
width,
height,

frames = 0,
score = 0,
best = 0,
fgpos = 0,
bgpos =0,

currentstate,
states = {
  Splash: 0, Game: 1, Score: 2
},

okbtn,

plane = {
// bepalen eerste positie plane 
  x: 80,
  y: 0,
  frame: 0,
  animation: [0, 1, 2, 1],
  rotation: 0,
  radius: 12,
  gravity: 0.25,
  _jump: 4.6,


  jump: function() {
    this.velocity = -this._jump;
  },

  update:function() {
// update de positie van de plane
    
// beetje omhoog en omlaag laten bewegen als Splash state

    if (currentstate === states.Splash) {
      this.y = height - 280 + 5 * Math.cos(frames/20);
      this.rotation = -0.4;
    } else {
      this.velocity += this.gravity;
      this.y += this.velocity;

// jump wanneer geklikt wordt, tot met water rand 
      if (this.y >= height - s_fg.height + 80) {
        this.y = height - s_fg.height + 60;
        
        if (currentstate === states.Game) {
          currentstate = states.Score;
        }
        this.velocity = this._jump;
      }
    }

    if (this.velocity >= this._jump) {
      // vliegtuig verticaal rotatie naar beneden
      this.rotation = Math.min(Math.PI/4, this.rotation + 0.3);
    } else {
      // rotatie bij het jumpen
      this.rotation = -0.2
    }

    if (this.y < 0) {
      this.velocity = 0;
    }

  },

  draw:function(ctx) {
// draaien van het vliegtuig
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);

// n antal keer
    var n = this.animation[this.frame];
    s_plane[n].draw(ctx, -s_plane[n].width/2, -s_plane[n].height/2);
    
    ctx.restore();

  },
},

palms = {

  _palms: [],
  // om de palmen te clearen
  reset: function() {
    this._palms = [];
  },

  update: function() {
    // elke 100px een nieuwe palm, 200 * Math om random hoogte te genereren
    if (frames % 180 === 0) {
      var _y = height - (s_cloud.height + s_fg.height + 120 + 200 * Math.random());
      this._palms.push({
        x: 500,
        y: _y,
        width: s_cloud.width,
        height: s_cloud.height
      });
    }
    // update de palms
    for (var i = 0, len = this._palms.length; i < len; i++ ) {
      var p = this._palms[i];

      if (i === 0) {

        // score vergroten
        score += p.x === plane.x ? 1 : 0;

      //  bepalen van r, wanneer plane botst: afgelopen.
        var cx = Math.min(Math.max(plane.x, p.x), p.x+p.width);
        var cy1 = Math.min(Math.max(plane.y, p.y), p.y+p.height);
        var cy2 = Math.min(Math.max(plane.y, p.y + p.height + 100), p.y+2*p.height+100);

        var dx = plane.x - cx;
        var dy1 = plane.y - cy1;
        var dy2 = plane.y - cy2;

        var d1 = dx*dx + dy1*dy1;
        var d2 = dx*dx + dy2*dy2;

        var r = plane.radius * plane.radius;

        if (r > d1 || r > d2) {
          currentstate = states.Score;
        }
      }
    // update de positie van de x vd palms
      p.x -= 2;
      if (p.x < -100) {
        this._palms.splice(i, 1);
        i--;
        len--;
      }
    }

  },
// tekenen palm en cloud. 90 is de hoogte tussen de wolk en palm
  draw: function(ctx) {
    for (var i = 0, len = this._palms.length; i < len; i++ ) {
      var p = this._palms[i];
      s_cloud.draw(ctx, p.x, p.y);
      s_palm.draw(ctx, p.x, p.y + 100 + p.height);
    }
  }
};

// evt = event
function onpress(evt) {
// in de game state en score state gooien
  switch (currentstate) {

    case states.Splash:
      currentstate = states.Game;
      plane.jump();
      break;

    case states.Game:
      plane.jump();
      break;

    case states.Score:
    // bepalen van de scores
      var mx = evt.offsetX, my = evt.offsetY;

      if (mx == null || my == null) {
        mx = evt.touches[0].clientX;
        my = evt.touches[0].clientY;
      }

      if (okbtn.x < mx && mx < okbtn.x + okbtn.width &&
        okbtn.y < my && my < okbtn.y + okbtn.height
      ) {
        palms.reset();
        currentstate = states.Splash;
        score = 0;
      }
      break;
  }

}

function main() {
  // title image above content


  canvas = document.createElement("canvas");
  

  width = window.innerWidth;
  height = window.innerHeight;

  // echt touch??
  var evt = "touchstart";
  // voor kleinere resoluties
  if (width >= 500) {
    width = 320;
    height = 480;
    canvas.style.border = "4px solid #C9309C";
    evt = "mousedown";
  }

  document.addEventListener(evt, onpress);

  canvas.width = width;
  canvas.height = height;
  ctx = canvas.getContext("2d");

// currentstate bepalen: de spalsh state
  currentstate = states.Splash;

//  body toevoegen aan de canvas
  document.body.appendChild(canvas);

  var img = new Image();
  img.onload = function(){

// Sprite aanroepen
    initSprites(this);
// background kleur sky
    ctx.fillStyle = s_bg.color;

// ok button
  okbtn = {
    x: (width - s_buttons.Ok.width)/2,
    y: height - 150,
    width: s_buttons.Ok.width,
    height: s_buttons.Ok.height
  }

    run();
  }
  img.src = "./img/sheetPlane.png";
}

function run() {
  var loop = function() {
    update();
    render();
    window.requestAnimationFrame(loop, canvas);
  }
  window.requestAnimationFrame(loop, canvas);
}

function update() {
  frames ++;
  if (currentstate !== states.Score) {
// Laat de foreground bewegen
    fgpos = (fgpos - 2) % 80;
    bgpos = (bgpos - 2) % 99;
  } else {
// Best score update
    best = Math.max(best, score);

  }

  if (currentstate === states.Game) {
    palms.update();
  }

  plane.update();
}

function render() {
// fill background kleur sky
ctx.fillRect(0, 0, width, height);

// teken background, plane en palmbomen

  s_bg.draw(ctx, bgpos, height - s_bg.height);
  s_bg.draw(ctx, bgpos + s_bg.width, height - s_bg.height);

  plane.draw(ctx);

// maak forground
  s_fg.draw(ctx, fgpos, height - s_fg.height);
  s_fg.draw(ctx, fgpos + s_fg.width, height - s_fg.height);

  palms.draw(ctx);


// center
  var width2 = width/2;

// voor de splash state: img
  if (currentstate === states.Splash){
    s_splash.draw(ctx, width2 - s_splash.width/2, height - 300);
// text ready
  s_text.GetReady.draw(ctx, width2 - s_text.GetReady.width/2, height - 380);    
  }
// Gameover & score bord 
  if (currentstate === states.Score) {
  s_text.GameOver.draw(ctx, width2 - s_text.GameOver.width/2, height - 400);
  s_score.draw(ctx, width2 - s_score.width/2.5, height - 320);  
// okbutton tekenen
  s_buttons.Ok.draw(ctx, okbtn.x, okbtn.y); 

// score invoeren op bord
  s_numberS.draw(ctx, width2, height-284, score, null, 10);
  s_numberS.draw(ctx, width2  , height-242, best, null, 10);

  } else { 
// score tekenen
    s_numberB.draw(ctx, width2, 30, score);

  }
}

main();
</script> 


</body>
</html>
